<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Synth</title>
    <script src="qwerty-hancock.js"></script>
</head>
<body>
<div>
<div id="keyboard"></div>
<canvas id="visualizer" width="600" height="150"></canvas>
</div>
<script>
  var keyboard = new QwertyHancock({
      id: 'keyboard',
      startNote: 'A2',
      octaves: 3,
      width: 600,
      height: 150,
  });

  var context = new AudioContext();

  var stepCurve = new Float32Array(256);
  for (var i=0; i<128; i++) stepCurve[i] = -1;
  for (var i=128; i<256; i++) stepCurve[i] = 1;

  var bumpCurve = new Float32Array(2);
  for (var i=0; i<2; i++) bumpCurve[i] = 1;

  function sawtooth(out) {
	  var osc = context.createOscillator();
	  osc.type = 'sawtooth';
	  osc.frequency.value = 440;

      var pwm = context.createWaveShaper();
      pwm.curve = stepCurve;
      //pwm.oversample = '2x';

      var gain = context.createGain();
      var width = gain.gain;
      width.value = 0.5;

      var bump = context.createWaveShaper();
      bump.curve = bumpCurve;

      osc.connect(pwm);
      gain.connect(pwm);

      osc.connect(bump);
      bump.connect(gain);

      osc.start();

	  return {
        width: width, 
	  	connect: function(out) {
		    pwm.connect(out);
		},
		setFrequency: function(frequency, now) { 
		      osc.frequency.linearRampToValueAtTime(frequency, now);
		}
	  };
  }


  var osc1 = sawtooth();
  var osc2 = sawtooth();
  var osc3 = sawtooth();


  var env = context.createGain();
  env.gain.value = 0;

  osc1.connect(env);
  osc2.connect(env);
  osc3.connect(env);

  var analyser = context.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.85;

  env.connect(analyser);
  analyser.connect(context.destination);

  keyboard.keyDown = function (note, frequency) {
      context.resume().then(function(){
      now = context.currentTime+0.1;
      amp = env.gain.value;
      env.gain.cancelScheduledValues(now);
      env.gain.setValueAtTime(amp, now);

      osc1.setFrequency(frequency, now);
      osc2.setFrequency(frequency*0.25, now);
      osc3.setFrequency(frequency*0.5, now);

      env.gain.linearRampToValueAtTime(1, now);
      })
  };

  keyboard.keyUp = function (node, frequency) {
      now = context.currentTime;
      amp = env.gain.value;

      env.gain.cancelScheduledValues(now);
      env.gain.setValueAtTime(amp, now);

      env.gain.linearRampToValueAtTime(0, now + 0.5);
  }

  var bufferLength = analyser.fftSize;
  var graphLength = bufferLength/2;
  var dataArray = new Float32Array(bufferLength);
  var canvas = document.querySelector('#visualizer');
  var canvasCtx = canvas.getContext("2d");
  WIDTH = canvas.width;
  HEIGHT = canvas.height;

  function draw() {
	  requestAnimationFrame(draw);
	  analyser.getFloatTimeDomainData(dataArray);

	  canvasCtx.fillStyle = 'rgb(200, 200, 200)';
	  canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
	  canvasCtx.lineWidth = 2;
	  canvasCtx.strokeStyle = 'rgb(0, 0, 0)';
	  canvasCtx.beginPath();

	  var sliceWidth = WIDTH * 1.0 / graphLength;
	  var x = 0;
      var s =  0

      while (s < graphLength && dataArray[s] > 0 ) { s++; }

      while (s < graphLength && dataArray[s] < 0.05) {
        s++;
      }

	  for(var i=0 ; i< graphLength; i++) {
	    var v = dataArray[s+i] * HEIGHT/4;
	    var y = HEIGHT/2 + v;

	    if(i === 0) {
	      canvasCtx.moveTo(x, y);
	    } else {
	      canvasCtx.lineTo(x, y);
	    }
	    x += sliceWidth;
      }

      canvasCtx.lineTo(canvas.width, canvas.height/2);
      canvasCtx.stroke();
  };

  canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
  draw();

  // proper unlocking of context
  // draw better keyboard without weird bug
  // osciliscope zero crossing
  // polyphony

  // juno simulation
  // pwm , saw, sub oscilators
  // pmw = sawtooth 
  // envelope 
  // release / decay properly i.e  aim over then fall down to note


  // chorus effect? delay?
</script> 
</body></html>
